<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin - Votre Concessionnaire Auto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body class="bg-gray-100 font-sans">

  <div class="max-w-6xl mx-auto py-10 px-4">
    <h1 class="text-3xl font-bold text-center mb-8 text-yellow-600">üìä Tableau de bord Administration</h1>

    <div class="text-right mb-6">
      <button id="logoutButton" class="bg-red-600 text-white font-bold py-2 px-4 rounded hover:bg-red-700 transition duration-300">
        <i class="fas fa-sign-out-alt mr-2"></i>D√©connexion
      </button>
    </div>

    <h2 class="text-2xl font-bold mb-6 text-yellow-600">üìù Demandes de Devis & Location</h2>
    <div class="overflow-x-auto mb-10">
      <table class="min-w-full bg-white shadow rounded-lg">
        <thead class="bg-yellow-600 text-white">
          <tr>
            <th class="py-3 px-4 text-left">Code Demande</th>
            <th class="py-3 px-4 text-left">Client</th>
            <th class="py-3 px-4 text-left">Type</th>
            <th class="py-3 px-4 text-left">V√©hicule</th>
            <th class="py-3 px-4 text-left">P√©riode Location</th>
            <th class="py-3 px-4 text-left">Message</th>
            <th class="py-3 px-4 text-left">Date</th>
            <th class="py-3 px-4 text-left">Statut</th>
            <th class="py-3 px-4 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="requestList" class="text-gray-700">
          <tr><td colspan="9" class="text-center py-4">Chargement des demandes...</td></tr>
        </tbody>
      </table>
    </div>

    <h2 class="text-2xl font-bold mb-6 text-yellow-600">üóìÔ∏è Demandes d'Essai Routier</h2>
    <div class="overflow-x-auto mb-10">
      <table class="min-w-full bg-white shadow rounded-lg">
        <thead class="bg-yellow-600 text-white">
          <tr>
            <th class="py-3 px-4 text-left">Code Essai</th>
            <th class="py-3 px-4 text-left">Client</th>
            <th class="py-3 px-4 text-left">V√©hicule</th>
            <th class="py-3 px-4 text-left">Date & Heure</th>
            <th class="py-3 px-4 text-left">Message</th>
            <th class="py-3 px-4 text-left">Statut</th>
            <th class="py-3 px-4 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="testDriveList" class="text-gray-700">
          <tr><td colspan="7" class="text-center py-4">Chargement des essais routiers...</td></tr>
        </tbody>
      </table>
    </div>

    <h2 class="text-2xl font-bold mb-6 text-yellow-600">üöó Gestion des V√©hicules</h2>

    <div class="bg-white p-6 rounded-lg shadow-lg mb-10">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Ajouter un nouveau v√©hicule</h3>
      <form id="addVehicleForm" class="space-y-4">
        <input type="text" id="vehicleName" class="w-full p-3 border border-gray-300 rounded focus:ring focus:ring-yellow-500" placeholder="Nom du v√©hicule (ex: Toyota Hilux 2023)" required>
        <textarea id="vehicleDescription" class="w-full p-3 border border-gray-300 rounded focus:ring focus:ring-yellow-500 h-24" placeholder="Description du v√©hicule (caract√©ristiques, √©tat)" required></textarea>
        <input type="text" id="vehiclePrice" class="w-full p-3 border border-gray-300 rounded focus:ring focus:ring-yellow-500" placeholder="Prix (ex: 25.000.000 F CFA ou 50.000 F CFA/jour)" required>
        <input type="text" id="vehicleImageUrl" class="w-full p-3 border border-gray-300 rounded focus:ring focus:ring-yellow-500" placeholder="URL de l'image du v√©hicule (Imgur, etc.)" required>
        <select id="vehicleCategory" class="w-full p-3 border border-gray-300 rounded focus:ring focus:ring-yellow-500" required>
            <option value="">S√©lectionnez une cat√©gorie</option>
            <option value="voitures">Voitures</option>
            <option value="camions">Camions</option>
            <option value="suv">SUV & 4x4</option>
            <option value="motos">Motos</option>
            <option value="vans">Vans & Minibus</option>
            <option value="autres">Autres</option>
        </select>
        <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded hover:bg-green-700 transition duration-300">
          <i class="fas fa-plus-circle mr-2"></i>Ajouter V√©hicule
        </button>
      </form>
      <p id="addVehicleMessage" class="mt-4 text-center text-sm"></p>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-lg">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Liste des V√©hicules</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white">
          <thead class="bg-gray-200 text-gray-700">
            <tr>
              <th class="py-3 px-4 text-left">Nom</th>
              <th class="py-3 px-4 text-left">Cat√©gorie</th>
              <th class="py-3 px-4 text-left">Prix</th>
              <th class="py-3 px-4 text-left">Image</th>
              <th class="py-3 px-4 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="vehicleList" class="text-gray-700">
            <tr><td colspan="5" class="text-center py-4">Chargement des v√©hicules...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    // Firebase Config (Doit correspondre √† celle de index.html et login.html)
    const firebaseConfig = {
      apiKey: "AIzaSyDhn7_DT49CWkg5atHPz3hZVYnPVSLdaos", // REMPLACEZ PAR VOTRE VRAIE CL√â API
      authDomain: "automobile-c6769.firebaseapp.com",
      projectId: "automobile-c6769",
      storageBucket: "automobile-c6769.firebasestorage.app",
      messagingSenderId: "672823943035",
      appId: "1:672823943035:web:f8ff8623623cebf58b67de",
      measurementId: "G-FCYWVT83Y2" // Ceci est pour Google Analytics, pas directement utilis√© par Firestore ou Auth
    };

    // Initialisation de Firebase avec la syntaxe COMPATIBLE (via l'objet global 'firebase')
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();   // Pour Firestore
    const auth = firebase.auth();     // Pour l'authentification

    // --- V√©rification de l'authentification ---
    auth.onAuthStateChanged(user => {
      if (!user) {
        // Aucun utilisateur connect√©, rediriger vers la page de connexion
        window.location.href = "login.html";
      } else {
        console.log("Admin connect√©:", user.email);
        // Charger les donn√©es uniquement si l'utilisateur est authentifi√©
        loadRequests();
        loadTestDrives();
        loadVehicles();
      }
    });

    // --- D√©connexion ---
    document.getElementById('logoutButton').addEventListener('click', () => {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      }).catch(error => {
        console.error("Erreur de d√©connexion:", error);
        alert("Erreur de d√©connexion: " + error.message);
      });
    });


    // --- Chargement des Demandes de Devis & Location ---
    const requestListTable = document.getElementById('requestList');

    async function loadRequests() {
      requestListTable.innerHTML = '<tr><td colspan="9" class="text-center py-4">Chargement des demandes...</td></tr>';
      try {
        const snapshot = await db.collection("requests").orderBy("timestamp", "desc").get();
        requestListTable.innerHTML = ''; // Effacer le message de chargement

        if (snapshot.empty) {
          requestListTable.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">Aucune demande trouv√©e.</td></tr>';
          return;
        }

        snapshot.docs.forEach(doc => {
          const request = doc.data();
          const tr = document.createElement('tr');
          tr.className = 'border-b last:border-b-0';
          
          tr.innerHTML = `
            <td class="py-3 px-4">${request.requestNumber || 'N/A'}</td>
            <td class="py-3 px-4">
                <strong>${request.clientName}</strong><br>
                ${request.clientEmail}<br>
                ${request.clientPhone}
            </td>
            <td class="py-3 px-4">${request.requestType === 'achat' ? 'Achat' : 'Location'}</td>
            <td class="py-3 px-4">${request.vehicle}</td>
            <td class="py-3 px-4">${request.rentalPeriod || 'N/A'}</td>
            <td class="py-3 px-4 text-sm max-w-xs overflow-hidden text-ellipsis whitespace-nowrap" title="${request.message}">${request.message || 'N/A'}</td>
            <td class="py-3 px-4">${request.timestamp ? new Date(request.timestamp.toDate()).toLocaleString('fr-FR') : 'N/A'}</td>
            <td class="py-3 px-4">
                <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                    request.status === 'En attente' ? 'bg-yellow-100 text-yellow-800' :
                    request.status === 'Trait√©e' ? 'bg-green-100 text-green-800' :
                    'bg-gray-100 text-gray-800'
                }">${request.status}</span>
            </td>
            <td class="py-3 px-4">
                <select onchange="updateRequestStatus('${doc.id}', this.value)" 
                                class="p-2 border border-gray-300 rounded text-sm">
                    <option value="En attente" ${request.status === 'En attente' ? 'selected' : ''}>En attente</option>
                    <option value="Trait√©e" ${request.status === 'Trait√©e' ? 'selected' : ''}>Trait√©e</option>
                    <option value="Annul√©e" ${request.status === 'Annul√©e' ? 'selected' : ''}>Annul√©e</option>
                </select>
                <button onclick="deleteRequest('${doc.id}')" 
                                class="ml-2 bg-red-500 text-white p-2 rounded text-sm hover:bg-red-600 transition duration-200" title="Supprimer">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
          `;
          requestListTable.appendChild(tr);
        });
      } catch (error) {
        console.error("‚ùå Erreur lors du chargement des demandes :", error);
        requestListTable.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-red-600">Erreur de chargement des demandes.</td></tr>';
      }
    }

    async function updateRequestStatus(requestId, newStatus) {
      try {
        await db.collection("requests").doc(requestId).update({ status: newStatus });
        console.log("Statut de la demande mis √† jour !");
        loadRequests(); // Recharger pour refl√©ter les changements
      } catch (error) {
        console.error("‚ùå Erreur lors de la mise √† jour du statut de la demande :", error);
        alert("Erreur lors de la mise √† jour du statut : " + error.message);
      }
    }
    window.updateRequestStatus = updateRequestStatus; // Exposer √† la fen√™tre globale

    async function deleteRequest(requestId) {
      if (confirm("Voulez-vous vraiment supprimer cette demande ?")) {
        try {
          await db.collection("requests").doc(requestId).delete();
          console.log("üóëÔ∏è Demande supprim√©e de Firestore");
          loadRequests(); // Recharger apr√®s suppression
        } catch (error) {
          console.error("‚ùå Erreur lors de la suppression de la demande :", error);
          alert("Erreur lors de la suppression de la demande : " + error.message);
        }
      }
    }
    window.deleteRequest = deleteRequest; // Exposer √† la fen√™tre globale


    // --- Chargement des Demandes d'Essai Routier ---
    const testDriveListTable = document.getElementById('testDriveList');

    async function loadTestDrives() {
      testDriveListTable.innerHTML = '<tr><td colspan="7" class="text-center py-4">Chargement des essais routiers...</td></tr>';
      try {
        const snapshot = await db.collection("testDrives").orderBy("timestamp", "desc").get();
        testDriveListTable.innerHTML = ''; // Effacer le message de chargement

        if (snapshot.empty) {
          testDriveListTable.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Aucune demande d\'essai routier trouv√©e.</td></tr>';
          return;
        }

        snapshot.docs.forEach(doc => {
          const testDrive = doc.data();
          const tr = document.createElement('tr');
          tr.className = 'border-b last:border-b-0';
          
          tr.innerHTML = `
            <td class="py-3 px-4">${testDrive.testDriveNumber || 'N/A'}</td>
            <td class="py-3 px-4">
                <strong>${testDrive.clientName}</strong><br>
                ${testDrive.clientEmail}<br>
                ${testDrive.clientPhone}
            </td>
            <td class="py-3 px-4">${testDrive.vehicle}</td>
            <td class="py-3 px-4">${testDrive.date} √† ${testDrive.time}</td>
            <td class="py-3 px-4 text-sm max-w-xs overflow-hidden text-ellipsis whitespace-nowrap" title="${testDrive.message}">${testDrive.message || 'N/A'}</td>
            <td class="py-3 px-4">
                <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                    testDrive.status === 'Confirm√©' ? 'bg-green-100 text-green-800' :
                    testDrive.status === 'Annul√©' ? 'bg-red-100 text-red-800' :
                    'bg-gray-100 text-gray-800'
                }">${testDrive.status}</span>
            </td>
            <td class="py-3 px-4">
                <select onchange="updateTestDriveStatus('${doc.id}', this.value)" 
                                class="p-2 border border-gray-300 rounded text-sm">
                    <option value="Confirm√©" ${testDrive.status === 'Confirm√©' ? 'selected' : ''}>Confirm√©</option>
                    <option value="Annul√©" ${testDrive.status === 'Annul√©' ? 'selected' : ''}>Annul√©</option>
                    <option value="Termin√©" ${testDrive.status === 'Termin√©' ? 'selected' : ''}>Termin√©</option>
                </select>
                <button onclick="deleteTestDrive('${doc.id}')" 
                                class="ml-2 bg-red-500 text-white p-2 rounded text-sm hover:bg-red-600 transition duration-200" title="Supprimer">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
          `;
          testDriveListTable.appendChild(tr);
        });
      } catch (error) {
        console.error("‚ùå Erreur lors du chargement des essais routiers :", error);
        testDriveListTable.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-600">Erreur de chargement des essais routiers.</td></tr>';
      }
    }

    async function updateTestDriveStatus(testDriveId, newStatus) {
      try {
        await db.collection("testDrives").doc(testDriveId).update({ status: newStatus });
        console.log("Statut de l'essai routier mis √† jour !");
        loadTestDrives(); // Recharger pour refl√©ter les changements
      } catch (error) {
        console.error("‚ùå Erreur lors de la mise √† jour du statut de l'essai routier :", error);
        alert("Erreur lors de la mise √† jour du statut : " + error.message);
      }
    }
    window.updateTestDriveStatus = updateTestDriveStatus; // Exposer √† la fen√™tre globale

    async function deleteTestDrive(testDriveId) {
      if (confirm("Voulez-vous vraiment supprimer cette demande d'essai routier ?")) {
        try {
          await db.collection("testDrives").doc(testDriveId).delete();
          console.log("üóëÔ∏è Demande d'essai routier supprim√©e de Firestore");
          loadTestDrives(); // Recharger apr√®s suppression
        } catch (error) {
          console.error("‚ùå Erreur lors de la suppression de la demande d'essai routier :", error);
          alert("Erreur lors de la suppression de la demande : " + error.message);
        }
      }
    }
    window.deleteTestDrive = deleteTestDrive; // Exposer √† la fen√™tre globale


    // --- Gestion des V√©hicules ---
    const addVehicleForm = document.getElementById('addVehicleForm');
    const addVehicleMessage = document.getElementById('addVehicleMessage');
    const vehicleListTable = document.getElementById('vehicleList');

    // Ajouter un nouveau v√©hicule
    addVehicleForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('vehicleName').value;
      const description = document.getElementById('vehicleDescription').value;
      const price = document.getElementById('vehiclePrice').value;
      const imageUrl = document.getElementById('vehicleImageUrl').value;
      const category = document.getElementById('vehicleCategory').value;

      try {
        await db.collection("vehicles").add({ 
          name: name,
          description: description,
          price: price,
          imageUrl: imageUrl,
          category: category,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        addVehicleMessage.textContent = 'V√©hicule ajout√© avec succ√®s !';
        addVehicleMessage.classList.remove('text-red-600');
        addVehicleMessage.classList.add('text-green-600');
        addVehicleForm.reset();
        loadVehicles(); // Recharger la liste des v√©hicules
      } catch (error) {
        console.error("‚ùå Erreur lors de l'ajout du v√©hicule :", error);
        addVehicleMessage.textContent = "Erreur lors de l'ajout du v√©hicule : " + error.message;
        addVehicleMessage.classList.remove('text-green-600');
        addVehicleMessage.classList.add('text-red-600');
      }
    });

    // Charger les v√©hicules
    async function loadVehicles() {
      vehicleListTable.innerHTML = '<tr><td colspan="5" class="text-center py-4">Chargement des v√©hicules...</td></tr>';
      try {
        const snapshot = await db.collection("vehicles").orderBy("name").get();
        vehicleListTable.innerHTML = ''; // Effacer le message de chargement

        if (snapshot.empty) {
            vehicleListTable.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Aucun v√©hicule trouv√©.</td></tr>';
            return;
        }

        snapshot.docs.forEach(doc => {
          const vehicle = doc.data();
          const tr = document.createElement('tr');
          tr.className = 'border-b last:border-b-0';
          
          tr.innerHTML = `
            <td class="py-3 px-4">${vehicle.name}</td>
            <td class="py-3 px-4">${vehicle.category}</td>
            <td class="py-3 px-4">${vehicle.price}</td>
            <td class="py-3 px-4">
                <img src="${vehicle.imageUrl}" alt="${vehicle.name}" class="h-12 w-12 object-cover rounded-md">
            </td>
            <td class="py-3 px-4">
                <button onclick="deleteVehicle('${doc.id}')" 
                                class="bg-red-500 text-white p-2 rounded text-sm hover:bg-red-600 transition duration-200" title="Supprimer">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
          `;
          vehicleListTable.appendChild(tr);
        });
      } catch (error) {
        console.error("‚ùå Erreur lors du chargement des v√©hicules :", error);
        vehicleListTable.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-600">Erreur de chargement des v√©hicules.</td></tr>';
      }
    }

    // Supprimer un v√©hicule
    async function deleteVehicle(vehicleId) {
      if (confirm("Voulez-vous vraiment supprimer ce v√©hicule ? (L'image ne sera pas supprim√©e automatiquement de l'h√©bergeur externe.)")) {
        try {
          await db.collection("vehicles").doc(vehicleId).delete();
          console.log("üóëÔ∏è V√©hicule supprim√© de Firestore");
          loadVehicles(); // Recharger la liste apr√®s suppression
        } catch (error) {
          console.error("‚ùå Erreur lors de la suppression du v√©hicule :", error);
          alert("Erreur lors de la suppression du v√©hicule : " + error.message);
        }
      }
    }
    window.deleteVehicle = deleteVehicle; // Exposer √† la fen√™tre globale

  </script>
</body>
</html>